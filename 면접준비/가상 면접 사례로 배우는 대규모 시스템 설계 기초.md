# 5장 안정 해시 설계
- 수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요
- 이때 안정 해시를 보편적으로 사용

## 해시 키 재배치 문제

- N개의 캐시 서버가 있고 부하를 균등하게 나누기 위해 아래 해시 삼수를 사용
    + ServerIndex = hash(key) % N(서버 대수)
    + key0 키의 경우 해시가 18358617일때 % 4를 하면 1의 ServerIndex가 나온다
- 위 경우에서 서버의 풀에 변화가 생기면 문제가 발생
- 1번 서버로 가던 요청이 1번 서버의 장애로 서버 풀이 변경되면 해시 재배치가 일어나는데 이때 대규모 캐시 미스가 발생

## 안정 해시
- 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술
    + k = 키의 개수
    + n = 슬롯의 개수
    + 전통적인 해시 테이블은 슬로의 수가 변경되면 대부분 키를 재배치 함

### 해시 공간과 해시 링
- SHA-1로 예를 들때 해시 공간 범위는 0부터 2^160 - 1까지라 알려져 있음
- 따라서 x0은 0, xn은 2^160 - 1이다
- 이 해시 공간을 링으로 만들면 x0과 xn이 맞닿은 모양이 된다

### 해시 서버
- 이때 해시 함수를 사용해서 서버의 정보로 해시 링의 어떤 위치에 대응 시킬 수 있음
    + 해시 슬롯에 서버 정보로 해시 함수를 돌려 저장한다는 뜻

### 해시 키
- 이때 키에 해시 함수를 돌려 나머지 연산을 하지 않고 해시 키도 슬롯에 배치를 시킴

### 서버 조회
- 이때 저장된 해시 키는 시계 방향으로 링을 탐색하면서 만나는 첫 번째 서버를 조회함

### 서버 추가 및 제거
- 위 셜명한 내용에 따르면 서버를 추가 또는 제거하면 키 가운데 일부분만 재배치하면 됨
- 나머지 키에는 영향이 없음

## 기본 구현법의 두 가지 문제
- 서버가 추가되거나 삭제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는게 불가능
- 키의 균등 분포를 달성하기가 어려움
- 해당 문제를 해결하기 위해 제안된 기법이 가상 노드 또는 복제 기법

### 가상 노드
- 실제 노드 또는 서버를 가리키는 노드로서 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다
- 가상 노드 개수를 늘리면 키의 분포는 점점 균등해 짐

